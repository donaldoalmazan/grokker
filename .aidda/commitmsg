move all of the header processing to a separate function
